# =============================================================================
# 0711 Intelligence Platform - Docker Compose
# =============================================================================
#
# Architecture:
#   - vLLM: Mixtral 8x7B with LoRA hot-swapping
#   - Embeddings: multilingual-e5-large
#   - Console: React frontend + FastAPI backend
#   - Infrastructure: PostgreSQL, Redis, MinIO
#
# Quick Start:
#   docker compose up -d
#
# With GPU (vLLM):
#   docker compose --profile gpu up -d
#
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # Infrastructure
  # ===========================================================================

  postgres:
    image: postgres:15-alpine
    container_name: 0711-postgres
    environment:
      POSTGRES_DB: 0711_control
      POSTGRES_USER: 0711
      POSTGRES_PASSWORD: ${DB_PASSWORD:-0711_dev_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "4005:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U 0711"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - 0711-network

  redis:
    image: redis:7-alpine
    container_name: 0711-redis
    volumes:
      - redis_data:/data
    ports:
      - "4060:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - 0711-network

  minio:
    image: minio/minio:latest
    container_name: 0711-minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-0711admin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-0711secret}
    ports:
      - "4050:9000"
      - "4051:9001"
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - 0711-network

  # ===========================================================================
  # Model Serving
  # ===========================================================================

  # vLLM - Mixtral 8x7B with LoRA support (requires GPU)
  vllm:
    build:
      context: .
      dockerfile: inference/Dockerfile
    container_name: 0711-vllm
    profiles:
      - gpu
    environment:
      - VLLM_MODEL=${VLLM_MODEL:-mistralai/Mixtral-8x7B-Instruct-v0.1}
      - VLLM_TENSOR_PARALLEL=${VLLM_TENSOR_PARALLEL:-1}
      - VLLM_MAX_MODEL_LEN=${VLLM_MAX_MODEL_LEN:-32768}
      - VLLM_GPU_MEMORY_UTILIZATION=${VLLM_GPU_MEMORY_UTILIZATION:-0.90}
      - LORA_MODULES_PATH=/lora
      - HF_TOKEN=${HF_TOKEN}
    ports:
      - "4030:8000"
    volumes:
      - ./models:/models
      - ./lora:/lora
      - huggingface_cache:/root/.cache/huggingface
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    networks:
      - 0711-network
    restart: unless-stopped

  # Embeddings - multilingual-e5-large
  embeddings:
    build:
      context: .
      dockerfile: inference/Dockerfile.embeddings
    container_name: 0711-embeddings
    environment:
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-intfloat/multilingual-e5-large}
      - EMBEDDING_HOST=0.0.0.0
      - EMBEDDING_PORT=8001
      - HF_TOKEN=${HF_TOKEN}
    ports:
      - "4040:8001"
    volumes:
      - huggingface_cache:/root/.cache/huggingface
    networks:
      - 0711-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Console
  # ===========================================================================

  console-backend:
    build:
      context: .
      dockerfile: console/backend/Dockerfile
    container_name: 0711-console-backend
    environment:
      - DATABASE_URL=postgresql://0711:${DB_PASSWORD:-0711_dev}@postgres:5432/0711
      - REDIS_URL=redis://redis:6379
      - VLLM_URL=http://vllm:8000
      - EMBEDDINGS_URL=http://embeddings:8001
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-0711admin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-0711secret}
      - LAKEHOUSE_PATH=/data/lakehouse
      - DEBUG=${DEBUG:-true}
    ports:
      - "4010:8080"
    volumes:
      - lakehouse_data:/data/lakehouse
      - ./core:/app/core
      - ./mcps:/app/mcps
      - ./inference:/app/inference
      - ./lakehouse:/app/lakehouse
      - ./ingestion:/app/ingestion
      - ./console/backend:/app/console/backend
      - ./zero711:/app/zero711
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      embeddings:
        condition: service_healthy
    networks:
      - 0711-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  console-frontend:
    build:
      context: .
      dockerfile: console/frontend/Dockerfile
    container_name: 0711-console-frontend
    environment:
      - BACKEND_URL=http://console-backend:8080
    ports:
      - "4020:3000"
    depends_on:
      - console-backend
    networks:
      - 0711-network
    restart: unless-stopped

  # ===========================================================================
  # Development Tools
  # ===========================================================================

  adminer:
    image: adminer:latest
    container_name: 0711-adminer
    profiles:
      - dev
    ports:
      - "4090:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
    depends_on:
      - postgres
    networks:
      - 0711-network

# =============================================================================
# Volumes
# =============================================================================

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
  lakehouse_data:
    driver: local
  huggingface_cache:
    driver: local

# =============================================================================
# Networks
# =============================================================================

networks:
  0711-network:
    driver: bridge
